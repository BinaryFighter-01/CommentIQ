// prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id                    String     @id @default(cuid())
  email                 String     @unique
  password              String     // hashed with bcryptjs
  name                  String
  createdAt             DateTime   @default(now())
  updatedAt             DateTime   @updatedAt
  
  // Relations
  analyses              Analysis[]
  usageMetrics          UsageMetrics?
  queueJobs             QueueJob[]
  
  @@index([email])
}

model VideoMetadata {
  id                    String     @id @default(cuid())
  videoId               String     @unique
  platform              String     // "youtube" or "reddit"
  title                 String
  url                   String
  views                 Int        @default(0)
  likes                 Int        @default(0)
  commentCount          Int        @default(0)
  authorName            String
  authorId              String
  fetchedAt             DateTime   @default(now())
  
  // Relations
  comments              Comment[]
  analyses              Analysis[]
  
  @@index([platform, videoId])
}

model Comment {
  id                    String     @id @default(cuid())
  commentId             String     @unique
  videoMetadataId       String
  videoMetadata         VideoMetadata @relation(fields: [videoMetadataId], onDelete: Cascade)
  
  authorName            String
  authorId              String
  content               String     @db.Text
  likes                 Int        @default(0)
  replies               Int        @default(0)
  createdAt             DateTime
  platform              String     // "youtube" or "reddit"
  
  // Relations
  analysis              Analysis?
  
  @@index([videoMetadataId])
  @@index([commentId])
}

model Analysis {
  id                    String     @id @default(cuid())
  userId                String
  user                  User       @relation(fields: [userId], onDelete: Cascade)
  
  videoMetadataId       String
  videoMetadata         VideoMetadata @relation(fields: [videoMetadataId], onDelete: Cascade)
  
  commentId             String     @unique
  comment               Comment    @relation(fields: [commentId], onDelete: Cascade)
  
  sentiment             String     // "positive", "negative", "neutral", "mixed"
  sentimentScore        Float      // -1 to 1
  toxicity              Float      // 0 to 1
  topics                String[]   @default([])
  summary               String     @db.Text
  keyPhrases            String[]   @default([])
  engagement            String     // "high", "medium", "low"
  
  processingTime        Int        // milliseconds
  costEstimate          Float      // in USD cents
  
  createdAt             DateTime   @default(now())
  
  @@index([userId])
  @@index([videoMetadataId])
  @@index([sentiment])
}

model AnalysisCache {
  id                    String     @id @default(cuid())
  contentHash           String     @unique // SHA256 hash of comment content
  analysisData          String     @db.Text // JSON stringified analysis
  platform              String
  expiresAt             DateTime
  createdAt             DateTime   @default(now())
  
  @@index([platform])
  @@index([expiresAt])
}

model QueueJob {
  id                    String     @id @default(cuid())
  userId                String
  user                  User       @relation(fields: [userId], onDelete: Cascade)
  
  jobType               String     // "analyze_comments", "fetch_video", "generate_insights"
  status                String     @default("pending") // "pending", "processing", "completed", "failed"
  
  payload               String     @db.Text // JSON stringified data
  result                String?    @db.Text // JSON stringified result
  error                 String?
  
  retryCount            Int        @default(0)
  maxRetries            Int        @default(3)
  
  processedAt           DateTime?
  completedAt           DateTime?
  createdAt             DateTime   @default(now())
  
  @@index([userId])
  @@index([status])
  @@index([jobType])
  @@index([createdAt])
}

model UsageMetrics {
  id                    String     @id @default(cuid())
  userId                String     @unique
  user                  User       @relation(fields: [userId], onDelete: Cascade)
  
  totalAnalyses         Int        @default(0)
  totalCommentsFetched  Int        @default(0)
  totalCostUSD          Float      @default(0)
  
  analysesThisHour      Int        @default(0)
  analysesThisDay       Int        @default(0)
  
  lastResetHour         DateTime   @default(now())
  lastResetDay          DateTime   @default(now())
  
  createdAt             DateTime   @default(now())
  updatedAt             DateTime   @updatedAt
}

model Insight {
  id                    String     @id @default(cuid())
  videoMetadataId       String
  videoMetadata         VideoMetadata @relation(fields: [videoMetadataId], onDelete: Cascade)
  
  insightType           String     // "top_questions", "sentiment_trend", "content_suggestions", etc.
  title                 String
  description           String     @db.Text
  data                  String     @db.Text // JSON
  
  createdAt             DateTime   @default(now())
  
  @@index([videoMetadataId])
  @@index([insightType])
}

model AnalysisAggregation {
  id                    String     @id @default(cuid())
  videoMetadataId       String     @unique
  videoMetadata         VideoMetadata @relation(fields: [videoMetadataId], onDelete: Cascade)
  
  // Sentiment
  positiveCount         Int        @default(0)
  negativeCount         Int        @default(0)
  neutralCount          Int        @default(0)
  mixedCount            Int        @default(0)
  averageSentiment      Float      @default(0)
  
  // Engagement
  highEngagementCount   Int        @default(0)
  mediumEngagementCount Int        @default(0)
  lowEngagementCount    Int        @default(0)
  
  // Toxicity
  averageToxicity       Float      @default(0)
  
  // Community
  topTopics             String[]   @default([])
  topPhrases            String[]   @default([])
  totalAnalyzed         Int        @default(0)
  
  lastUpdated           DateTime   @default(now())
  
  @@index([videoMetadataId])
}
